name: Build and Test

permissions:
  checks: write
  contents: read
  pull-requests: read

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  NODE_VERSION: '18.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  # Job 1: Build and Test Backend
  backend-build-and-test:
    name: ðŸ”¨ Backend (.NET)
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ”§ Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Restore NuGet packages
      run: dotnet restore
      
    - name: ðŸ—ï¸ Build solution (Debug)
      run: dotnet build --configuration Debug --no-restore
      
    - name: ðŸ—ï¸ Build solution (Release)
      run: dotnet build --configuration Release --no-restore
      
    - name: ðŸ§ª Run unit tests
      run: dotnet test --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"
      
    - name: ðŸ“Š Publish test results
      uses: dorny/test-reporter@v1
      if: (success() || failure()) && github.event.pull_request.head.repo.full_name == github.repository
      with:
        name: Backend Test Results
        path: '**/test-results.trx'
        reporter: dotnet-trx
        
    - name: ðŸ” Check for outdated packages
      run: dotnet list package --outdated
      continue-on-error: true
      
    - name: ðŸ›¡ï¸ Check for vulnerable packages
      run: dotnet list package --vulnerable --include-transitive
      
    - name: ðŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: backend-build
        path: |
          **/bin/Release/**
          !**/*.pdb
        retention-days: 7

  # Job 2: Build and Test Frontend
  frontend-build-and-test:
    name: ðŸŽ¨ Frontend (React)
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: Panoptes.Client/package-lock.json
        
    - name: ðŸ“¦ Install dependencies
      working-directory: ./Panoptes.Client
      run: npm ci
      
    - name: ðŸ—ï¸ Build frontend
      working-directory: ./Panoptes.Client
      run: npm run build
      
    - name: ðŸŽ¨ Run linter
      working-directory: ./Panoptes.Client
      run: npm run lint || echo "âš ï¸ Linting issues found"
      continue-on-error: true
      
    - name: ðŸ§ª Run tests (if configured)
      working-directory: ./Panoptes.Client
      run: npm test || echo "â„¹ï¸ No tests configured yet"
      continue-on-error: true
      
    - name: ðŸ“Š Check bundle size
      working-directory: ./Panoptes.Client
      run: |
        echo "ðŸ“¦ Build output size:"
        du -sh dist/ || echo "No dist folder"
        
    - name: ðŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: frontend-build
        path: Panoptes.Client/dist/
        retention-days: 7

  # Job 3: Security Checks
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'
        
    - name: ðŸ“¤ Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        
    - name: ðŸ›¡ï¸ NPM Security Audit
      working-directory: ./Panoptes.Client
      run: |
        echo "ðŸ” Running npm audit..."
        npm audit --audit-level=high || echo "âš ï¸ Vulnerabilities found"
      continue-on-error: true

  # Job 4: Code Quality & Secret Scanning
  code-quality:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ” Scan for secrets (TruffleHog)
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.pull_request.base.sha || format('refs/heads/{0}', github.event.repository.default_branch) }}
        head: ${{ github.event.pull_request.head.sha || github.sha }}
        extra_args: --only-verified
      continue-on-error: true
        
    - name: ðŸ”‘ Check for exposed API keys
      run: |
        echo "ðŸ” Scanning for exposed API keys..."
        
        # Check for API keys in currently tracked files only (not history)
        # This avoids false positives from .gitignored files that were accidentally committed
        
        # Check for hardcoded keys in tracked source code files
        if git ls-files | grep -E '\.(cs|ts|tsx)$' | xargs grep "ApiKey.*:" 2>/dev/null | grep -v "YOUR_.*_HERE" | grep -v "appsettings" | grep -E "(utxorpc|dmtr_)" -q; then
          echo "::error::âŒ Hardcoded API key detected in source code!"
          exit 1
        fi
        
        # Check tracked JSON files (excluding Local, Development, and node_modules)
        if git ls-files | grep '\.json$' | grep -v "Local" | grep -v "Development" | grep -v "node_modules" | grep -v "package-lock" | xargs grep "ApiKey" 2>/dev/null | grep -v "YOUR_.*_HERE" | grep -v '""' | grep -E "(utxorpc|dmtr_)" -q; then
          echo "::error::âŒ API key found in tracked JSON configuration!"
          echo "::error::Please remove the API key and use environment variables or placeholders"
          exit 1
        fi
        
        echo "âœ… No exposed API keys detected in tracked files"
        
    - name: ðŸ“‹ Verify .gitignore
      run: |
        echo "ðŸ” Verifying .gitignore configuration..."
        
        if [ ! -f .gitignore ]; then
          echo "::error::âŒ .gitignore file is missing!"
          exit 1
        fi
        
        # Check for required entries
        required_entries=("appsettings.Local.json" "appsettings.Development.json" "*.db" ".env")
        
        for entry in "${required_entries[@]}"; do
          if ! grep -q "$entry" .gitignore; then
            echo "::error::âŒ Required entry missing from .gitignore: $entry"
            exit 1
          fi
        done
        
        echo "âœ… .gitignore properly configured"
        
    - name: ðŸ” Check for debug code
      run: |
        echo "ðŸ” Checking for debug code..."
        
        if grep -r "console.log\|debugger" --include="*.ts" --include="*.tsx" Panoptes.Client/src/ | grep -v "node_modules" || true; then
          echo "::warning::âš ï¸ Debug statements found in frontend code"
        fi
        
        if grep -r "Console.WriteLine" --include="*.cs" | grep -v "// Allow\|Logging\|Worker" || true; then
          echo "::warning::âš ï¸ Console.WriteLine found (consider using ILogger)"
        fi
        
    - name: ðŸ“Š Code metrics
      run: |
        echo "ðŸ“Š Generating code metrics..."
        echo "### Backend (.NET)"
        find . -name "*.cs" -not -path "*/obj/*" -not -path "*/bin/*" | wc -l | xargs echo "C# files:"
        find . -name "*.cs" -not -path "*/obj/*" -not -path "*/bin/*" -exec wc -l {} + | tail -1 | awk '{print "Total lines:", $1}'
        echo ""
        echo "### Frontend (React)"
        find Panoptes.Client/src -name "*.ts" -o -name "*.tsx" | wc -l | xargs echo "TypeScript files:"
        find Panoptes.Client/src -name "*.ts" -o -name "*.tsx" -exec wc -l {} + | tail -1 | awk '{print "Total lines:", $1}'

  # Job 5: Lint Configuration Files
  lint-configs:
    name: ðŸ“ Lint Configs
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: âœ… Validate JSON files
      run: |
        echo "ðŸ” Validating JSON configuration files..."
        
        find . -name "*.json" \
          -not -path "*/node_modules/*" \
          -not -path "*/bin/*" \
          -not -path "*/obj/*" \
          -not -path "*/.vscode/*" \
          -not -name "tsconfig*.json" \
          | while read file; do
          
          echo "Checking: $file"
          if ! jq empty "$file" 2>/dev/null; then
            echo "::error::âŒ Invalid JSON in: $file"
            exit 1
          fi
        done
        
        echo "âœ… All JSON files are valid (tsconfig*.json excluded as JSONC)"
        
    - name: ðŸ“‹ Check required files
      run: |
        echo "ðŸ” Checking for required project files..."
        
        required_files=(
          "README.md"
          "LICENSE"
          "SECURITY.md"
          ".gitignore"
          "Panoptes.Api/appsettings.json"
          "Panoptes.Client/package.json"
          ".github/CONTRIBUTING.md"
          ".github/CODE_OF_CONDUCT.md"
        )
        
        missing_files=()
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files+=("$file")
          fi
        done
        
        if [ ${#missing_files[@]} -ne 0 ]; then
          echo "::error::âŒ Required files missing:"
          printf '%s\n' "${missing_files[@]}"
          exit 1
        fi
        
        echo "âœ… All required files present"

  # Job 6: Dependency Review (PR only)
  dependency-review:
    name: ðŸ” Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ” Review dependencies
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: high
        allow-licenses: MIT, Apache-2.0, BSD-3-Clause, ISC, 0BSD

  # Job 7: Build Summary
  build-summary:
    name: ðŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs: [backend-build-and-test, frontend-build-and-test, security-scan, code-quality, lint-configs]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate build summary
      run: |
        echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Build | ${{ needs.backend-build-and-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Build | ${{ needs.frontend-build-and-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Config Lint | ${{ needs.lint-configs.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View detailed results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
