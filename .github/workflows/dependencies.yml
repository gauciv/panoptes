name: Dependency Updates

on:
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dotnet-dependencies:
    name: ðŸ“¦ Update .NET Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: ðŸ” Check for updates
      id: check
      run: |
        echo "ðŸ” Checking for outdated packages..."
        dotnet list package --outdated > outdated.txt
        cat outdated.txt
        
        if grep -q "Top-level Package" outdated.txt; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸ“Š Update packages
      if: steps.check.outputs.has_updates == 'true'
      run: |
        # Update packages (one at a time for safety)
        dotnet list package --outdated | grep ">" | awk '{print $2}' | while read package; do
          echo "Updating $package..."
          dotnet add package $package || echo "Failed to update $package"
        done
        
    - name: ðŸ§ª Test after updates
      if: steps.check.outputs.has_updates == 'true'
      run: |
        dotnet restore
        dotnet build --no-restore
        dotnet test --no-build
        
    - name: ðŸ“¤ Create Pull Request
      if: steps.check.outputs.has_updates == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore(deps): update .NET dependencies'
        title: 'ðŸ”„ Update .NET Dependencies'
        body: |
          ## ðŸ“¦ Dependency Updates
          
          This PR updates outdated .NET packages.
          
          ### Changes
          - Automated package updates via `dotnet list package --outdated`
          
          ### Testing
          - âœ… Build successful
          - âœ… Tests passing
          
          ### Review
          Please review the changes and ensure everything works as expected.
          
          ---
          *Automated by GitHub Actions*
        branch: chore/update-dotnet-deps
        delete-branch: true
        labels: dependencies, automated

  update-npm-dependencies:
    name: ðŸ“¦ Update NPM Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: Panoptes.Client/package-lock.json
        
    - name: ðŸ“Š Update npm packages
      working-directory: ./Panoptes.Client
      run: |
        npm update
        npm audit fix || true
        
    - name: ðŸ§ª Test after updates
      working-directory: ./Panoptes.Client
      run: |
        npm ci
        npm run build
        
    - name: ðŸ“¤ Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore(deps): update npm dependencies'
        title: 'ðŸ”„ Update NPM Dependencies'
        body: |
          ## ðŸ“¦ Dependency Updates
          
          This PR updates npm packages in the frontend.
          
          ### Changes
          - Ran `npm update`
          - Ran `npm audit fix` (if applicable)
          
          ### Testing
          - âœ… Build successful
          
          ### Review
          Please review the changes and test the frontend thoroughly.
          
          ---
          *Automated by GitHub Actions*
        branch: chore/update-npm-deps
        delete-branch: true
        labels: dependencies, automated

  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: Panoptes.Client/package-lock.json
        
    - name: ðŸ›¡ï¸ .NET vulnerability check
      run: |
        echo "ðŸ” Checking for .NET vulnerabilities..."
        dotnet list package --vulnerable --include-transitive > vulnerabilities.txt
        cat vulnerabilities.txt
        
        if grep -q "has the following vulnerable packages" vulnerabilities.txt; then
          echo "::warning::âš ï¸ Vulnerable .NET packages found!"
          cat vulnerabilities.txt >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ›¡ï¸ NPM vulnerability check
      working-directory: ./Panoptes.Client
      run: |
        echo "ðŸ” Running npm audit..."
        npm audit --json > ../npm-audit.json || true
        
        if [ -s ../npm-audit.json ]; then
          echo "### ðŸ“Š NPM Security Audit" >> $GITHUB_STEP_SUMMARY
          npm audit >> $GITHUB_STEP_SUMMARY || true
        fi
        
    - name: ðŸ“Š Create issue if vulnerabilities found
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = 'ðŸ”’ Security Vulnerabilities Detected';
          const body = `## Security Audit Report
          
          Automated security audit detected vulnerabilities in dependencies.
          
          ### Action Required
          Please review the workflow run for details and update affected packages.
          
          ðŸ”— [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          *Automated by GitHub Actions*`;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['security', 'dependencies']
          });
